/**
 * Shopping List Sharing Module
 * Share grocery lists via email, SMS, or export
 */

class ShoppingListSharer {
    constructor() {
        this.settings = this.loadSettings();
    }
    
    /**
     * Load user sharing settings
     */
    loadSettings() {
        const defaults = {
            emailRecipients: [],
            smsNumbers: [],
            autoShare: false,
            shareFormat: 'categorized',
            includeNotes: true
        };
        
        try {
            const saved = localStorage.getItem('shopping_share_settings');
            return saved ? { ...defaults, ...JSON.parse(saved) } : defaults;
        } catch (e) {
            return defaults;
        }
    }
    
    /**
     * Save sharing settings
     */
    saveSettings() {
        localStorage.setItem('shopping_share_settings', JSON.stringify(this.settings));
    }
    
    /**
     * Format shopping list for sharing
     */
    formatList(list, format = 'categorized') {
        let formatted = '';
        const date = new Date().toLocaleDateString('en-AU');
        
        switch (format) {
            case 'categorized':
                formatted = this.formatCategorized(list, date);
                break;
            case 'simple':
                formatted = this.formatSimple(list, date);
                break;
            case 'print':
                formatted = this.formatPrint(list, date);
                break;
        }
        
        return formatted;
    }
    
    /**
     * Categorized format (default)
     */
    formatCategorized(list, date) {
        let text = `ðŸ›’ Shopping List - ${date}\n\n`;
        
        // Group by category if available
        if (list.categorized) {
            for (const [category, items] of Object.entries(list.categorized)) {
                if (items.length > 0) {
                    text += `\n${category.toUpperCase()}:\n`;
                    items.forEach(item => {
                        text += `â€¢ ${item.quantity} ${item.unit} ${item.name}\n`;
                    });
                }
            }
        } else {
            // Simple list
            list.items?.forEach(item => {
                text += `â€¢ ${item.quantity} ${item.unit} ${item.name}\n`;
            });
        }
        
        text += `\nTotal items: ${list.totalItems || list.items?.length || 0}`;
        return text;
    }
    
    /**
     * Simple format for SMS
     */
    formatSimple(list, date) {
        let text = `Shopping ${date}:\n`;
        
        list.items?.forEach(item => {
            text += `- ${item.quantity} ${item.unit} ${item.name}\n`;
        });
        
        return text;
    }
    
    /**
     * Print-friendly format
     */
    formatPrint(list, date) {
        let html = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Shopping List - ${date}</title>
                <style>
                    body { font-family: -apple-system, sans-serif; padding: 20px; }
                    h1 { color: #007AFF; }
                    .category { margin: 20px 0; }
                    .category h2 { border-bottom: 2px solid #007AFF; padding-bottom: 5px; }
                    .item { margin: 5px 0; }
                    .checkbox { margin-right: 10px; }
                    .footer { margin-top: 30px; color: #666; font-size: 12px; }
                </style>
            </head>
            <body>
                <h1>ðŸ›’ Shopping List</h1>
                <p><strong>Date:</strong> ${date}</p>
        `;
        
        if (list.categorized) {
            for (const [category, items] of Object.entries(list.categorized)) {
                if (items.length > 0) {
                    html += `
                        <div class="category">
                            <h2>${category}</h2>
                            ${items.map(item => `
                                <div class="item">
                                    <span class="checkbox">â–¡</span>
                                    ${item.quantity} ${item.unit} ${item.name}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }
        }
        
        html += `
                <div class="footer">
                    <p>Total items: ${list.totalItems || list.items?.length || 0}</p>
                    <p>Generated by Family Recipes App</p>
                </div>
            </body>
            </html>
        `;
        
        return html;
    }
    
    /**
     * Share via email
     */
    async shareViaEmail(list, recipients = null) {
        const emailRecipients = recipients || this.settings.emailRecipients;
        
        if (emailRecipients.length === 0) {
            throw new Error('No email recipients configured');
        }
        
        const subject = `Shopping List - ${new Date().toLocaleDateString('en-AU')}`;
        const body = this.formatList(list, this.settings.shareFormat);
        
        // Create mailto link
        const mailtoLink = `mailto:${emailRecipients.join(',')}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        
        // Open email client
        window.location.href = mailtoLink;
        
        return { success: true, method: 'email', recipients: emailRecipients };
    }
    
    /**
     * Share via SMS (opens messaging app)
     */
    async shareViaSMS(list, phoneNumbers = null) {
        const smsNumbers = phoneNumbers || this.settings.smsNumbers;
        
        if (smsNumbers.length === 0) {
            throw new Error('No phone numbers configured');
        }
        
        const body = this.formatList(list, 'simple');
        
        // Create SMS link (works on mobile)
        const smsLink = `sms:${smsNumbers.join(',')}?body=${encodeURIComponent(body)}`;
        
        // Open messaging app
        window.location.href = smsLink;
        
        return { success: true, method: 'sms', recipients: smsNumbers };
    }
    
    /**
     * Print shopping list
     */
    async printList(list) {
        const printWindow = window.open('', '_blank');
        const printContent = this.formatList(list, 'print');
        
        printWindow.document.write(printContent);
        printWindow.document.close();
        
        // Wait for content to load
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
        
        return { success: true, method: 'print' };
    }
    
    /**
     * Copy to clipboard
     */
    async copyToClipboard(list) {
        const text = this.formatList(list, 'simple');
        
        try {
            await navigator.clipboard.writeText(text);
            return { success: true, method: 'clipboard' };
        } catch (error) {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            return { success: true, method: 'clipboard' };
        }
    }
    
    /**
     * Export as JSON file
     */
    async exportAsJSON(list) {
        const data = {
            list: list,
            generated: new Date().toISOString(),
            version: '1.0'
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `shopping-list-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        URL.revokeObjectURL(url);
        
        return { success: true, method: 'json' };
    }
    
    /**
     * Save list to server
     */
    async saveListToServer(list) {
        try {
            const response = await fetch('/api/save-shopping-list.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    list: list,
                    date: new Date().toISOString()
                })
            });
            
            return await response.json();
        } catch (error) {
            console.error('Save error:', error);
            throw error;
        }
    }
    
    /**
     * Get sharing history
     */
    async getSharingHistory() {
        try {
            const saved = localStorage.getItem('sharing_history');
            return saved ? JSON.parse(saved) : [];
        } catch (e) {
            return [];
        }
    }
    
    /**
     * Log sharing action
     */
    async logSharing(action, listId, method, recipients) {
        const history = await this.getSharingHistory();
        
        history.push({
            timestamp: new Date().toISOString(),
            action: action,
            listId: listId,
            method: method,
            recipients: recipients,
            itemCount: listId?.totalItems || 0
        });
        
        // Keep only last 50 entries
        if (history.length > 50) {
            history.shift();
        }
        
        localStorage.setItem('sharing_history', JSON.stringify(history));
    }
    
    /**
     * Create sharing UI
     */
    createSharingUI(list) {
        const container = document.createElement('div');
        container.className = 'sharing-options';
        
        container.innerHTML = `
            <div class="sharing-header">
                <h3>Share Shopping List</h3>
                <p>${list.totalItems || list.items?.length || 0} items</p>
            </div>
            
            <div class="sharing-buttons">
                <button class="share-btn email-btn" data-method="email">
                    <i data-lucide="mail"></i> Email
                </button>
                
                <button class="share-btn sms-btn" data-method="sms">
                    <i data-lucide="message-square"></i> SMS
                </button>
                
                <button class="share-btn print-btn" data-method="print">
                    <i data-lucide="printer"></i> Print
                </button>
                
                <button class="share-btn copy-btn" data-method="copy">
                    <i data-lucide="copy"></i> Copy
                </button>
                
                <button class="share-btn export-btn" data-method="export">
                    <i data-lucide="download"></i> Export
                </button>
            </div>
            
            <div class="sharing-settings">
                <label>
                    <input type="checkbox" id="auto-share"> Auto-share when list changes
                </label>
                
                <div class="recipients-section">
                    <h4>Email Recipients</h4>
                    <div class="recipients-list" id="email-recipients"></div>
                    <button class="add-recipient-btn" data-type="email">
                        <i data-lucide="plus"></i> Add Email
                    </button>
                </div>
                
                <div class="recipients-section">
                    <h4>SMS Numbers</h4>
                    <div class="recipients-list" id="sms-recipients"></div>
                    <button class="add-recipient-btn" data-type="sms">
                        <i data-lucide="plus"></i> Add Number
                    </button>
                </div>
            </div>
        `;
        
        // Add event listeners
        container.querySelectorAll('.share-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const method = btn.dataset.method;
                await this.handleShare(method, list);
            });
        });
        
        // Initialize recipients
        this.updateRecipientsUI();
        
        return container;
    }
    
    /**
     * Handle share action
     */
    async handleShare(method, list) {
        try {
            let result;
            
            switch (method) {
                case 'email':
                    result = await this.shareViaEmail(list);
                    break;
                case 'sms':
                    result = await this.shareViaSMS(list);
                    break;
                case 'print':
                    result = await this.printList(list);
                    break;
                case 'copy':
                    result = await this.copyToClipboard(list);
                    break;
                case 'export':
                    result = await this.exportAsJSON(list);
                    break;
            }
            
            // Log the action
            await this.logSharing('share', list, method, result?.recipients);
            
            // Show success message
            this.showToast(`Shared via ${method} successfully!`, 'success');
            
            return result;
            
        } catch (error) {
            console.error('Share error:', error);
            this.showToast(`Error: ${error.message}`, 'error');
            throw error;
        }
    }
    
    /**
     * Update recipients UI
     */
    updateRecipientsUI() {
        const emailContainer = document.getElementById('email-recipients');
        const smsContainer = document.getElementById('sms-recipients');
        
        if (emailContainer) {
            emailContainer.innerHTML = this.settings.emailRecipients
                .map(email => `
                    <div class="recipient">
                        <span>${email}</span>
                        <button class="remove-recipient" data-type="email" data-value="${email}">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                `).join('');
        }
        
        if (smsContainer) {
            smsContainer.innerHTML = this.settings.smsNumbers
                .map(number => `
                    <div class="recipient">
                        <span>${number}</span>
                        <button class="remove-recipient" data-type="sms" data-value="${number}">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                `).join('');
        }
        
        // Refresh icons
        if (window.lucide) {
            lucide.createIcons();
        }
    }
    
    /**
     * Show toast notification
     */
    showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        
        // Add to page
        document.body.appendChild(toast);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
}

// Create global instance
const shoppingListSharer = new ShoppingListSharer();

// Export for use in other modules
if (typeof module !== 'undefined' && module.exports) {
    module.exports = shoppingListSharer;
}